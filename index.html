<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeticDB - Sistema de Especializaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,400;0,700;1,900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Condensed', sans-serif; background-color: #05080f; color: #ffffff; letter-spacing: 0.02em; }
        .search-container { background-color: #0d1421; border: 1px solid #1a2436; }
        .card-main { background-color: #0b121f; border: 1px solid #1e293b; cursor: pointer; }
        .btn-orange { background: linear-gradient(to bottom, #f39c12, #d35400); box-shadow: 0 4px 15px rgba(211, 84, 0, 0.3); }
        .btn-blue { background: linear-gradient(to bottom, #3498db, #2980b9); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .level-pill { background: rgba(255, 255, 255, 0.05); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .modal-content { background-color: #0d1421; border: 1px solid #f39c12; }
        body:not(.is-admin) .admin-only { display: none !important; }
    </style>
</head>
<body class="p-4 md:p-10 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-amber-500 rounded-lg flex items-center justify-center relative overflow-hidden">
                    <div class="w-8 h-8 bg-black rotate-45 flex items-center justify-center"><div class="w-3 h-3 bg-amber-500"></div></div>
                </div>
                <div>
                    <h1 class="text-4xl font-black italic tracking-tighter leading-none uppercase">MEMETIC<span class="text-amber-500">DB</span></h1>
                    <p class="text-[11px] text-gray-500 font-bold tracking-[0.3em] uppercase mt-1">Base de Datos de Especializaciones</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button id="authBtn" onclick="toggleAuth()" class="border border-gray-600 hover:border-white text-gray-400 px-4 py-2 rounded uppercase text-xs font-bold tracking-widest transition-all">ðŸ”’ Admin Login</button>
                <button onclick="openItemModal()" class="admin-only btn-orange text-white font-bold py-3 px-6 rounded shadow-lg transition-all flex items-center gap-2 uppercase italic text-sm"><span>+</span> Memetica</button>
            </div>
        </header>

        <div class="flex flex-col md:flex-row gap-4 mb-10">
            <div class="relative flex-grow">
                <input type="text" id="searchInput" onkeyup="filterItems()" placeholder="Buscar especializaciÃ³n..." class="search-container w-full rounded-md py-5 pl-14 pr-4 focus:outline-none text-lg text-gray-400 font-light">
            </div>
            <div class="search-container rounded-md px-8 py-2 flex items-center gap-8 min-w-[200px]">
                 <div class="flex flex-col"><span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Modo Actual:</span><span class="text-xl font-bold text-white leading-none" id="modeDisplay">LECTURA</span></div>
                <div class="flex flex-col text-right ml-auto pl-8 border-l border-gray-800"><span class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Items:</span><span class="text-3xl font-black text-amber-500 leading-none" id="totalCount">0</span></div>
            </div>
        </div>

        <div id="mainContainer" class="space-y-12"></div>
    </div>

    <div id="loginModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-sm rounded-lg p-8 text-center">
            <h2 class="text-xl font-black italic uppercase mb-4 text-white">Acceso Editor</h2>
            <input type="text" id="adminUser" placeholder="Usuario" class="w-full bg-[#05080f] border border-gray-700 rounded p-3 text-white text-center mb-3 outline-none">
            <input type="password" id="adminPass" placeholder="ContraseÃ±a" class="w-full bg-[#05080f] border border-gray-700 rounded p-3 text-white text-center mb-4 outline-none">
            <button onclick="checkLogin()" class="w-full py-3 rounded btn-orange text-white font-bold text-sm uppercase">Ingresar</button>
            <button onclick="closeModals()" class="mt-4 text-xs text-gray-500 underline text-white">Cancelar</button>
        </div>
    </div>

    <div id="itemModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl rounded-lg p-8">
            <h2 id="modalTitle" class="text-2xl font-black italic uppercase mb-6 text-white border-b border-gray-800 pb-4">Nueva MemÃ©tica</h2>
            <form id="itemForm" onsubmit="saveItem(event)" class="space-y-5">
                <input type="hidden" id="itemId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <input type="text" id="itemName" placeholder="Nombre" required class="w-full bg-[#05080f] border border-gray-700 rounded p-3 text-white">
                    <select id="itemCategory" class="w-full bg-[#05080f] border border-gray-700 rounded p-3 text-white"></select>
                </div>
                <input type="text" id="itemImage" placeholder="URL del Icono (opcional)" class="w-full bg-[#05080f] border border-gray-700 rounded p-3 text-white">
                
                <textarea id="itemDesc" placeholder="DescripciÃ³n [Tags: tag1, tag2]" required rows="3" class="w-full bg-[#05080f] border border-gray-700 rounded p-3 text-white"></textarea>
                <input type="text" id="itemLevels" placeholder="Niveles (ej: 20, 30)" class="w-full bg-[#05080f] border border-gray-700 rounded p-3 text-white">
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-800">
                    <button type="button" onclick="closeModals()" class="px-6 py-2 rounded bg-gray-800 text-white font-bold text-sm">Cancelar</button>
                    <button type="submit" class="px-8 py-2 rounded btn-orange text-white font-bold text-sm uppercase">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let appData = { groups: {}, groupMeta: {} };
        let isAdmin = false;
        let sortableInstances = [];

        async function loadData() {
            try {
                const res = await fetch('/.netlify/functions/get_memetics');
                const data = await res.json();
                appData.groupMeta = {}; appData.groups = {};
                data.groups.forEach(g => {
                    appData.groupMeta[g.id] = { title: g.title, color: g.color };
                    appData.groups[g.id] = [];
                });
                data.memetics.forEach(m => {
                    if(appData.groups[m.group_id]) {
                        appData.groups[m.group_id].push({ 
                            id: m.id, 
                            name: m.name, 
                            desc: m.description, 
                            levels: m.levels,
                            image: m.image_url // Cargamos la imagen desde la DB
                        });
                    }
                });
                if (sessionStorage.getItem('is_admin') === 'true') setAdminUI(true);
                renderApp();
            } catch (err) { console.error("Error cargando datos"); }
        }

        async function saveItem(e) {
            e.preventDefault();
            const item = {
                id: document.getElementById('itemId').value || "m_" + Date.now(),
                name: document.getElementById('itemName').value,
                group_id: document.getElementById('itemCategory').value,
                description: document.getElementById('itemDesc').value,
                levels: document.getElementById('itemLevels').value,
                image_url: document.getElementById('itemImage').value // Guardamos la imagen
            };
            const res = await fetch('/.netlify/functions/save_memetic', { method: 'POST', body: JSON.stringify(item) });
            if(res.ok) { closeModals(); loadData(); }
        }

        function editItem(gid, id) {
            if (!isAdmin) return;
            const item = appData.groups[gid].find(i => i.id === id);
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = gid;
            document.getElementById('itemDesc').value = item.desc;
            document.getElementById('itemLevels').value = item.levels;
            document.getElementById('itemImage').value = item.image || ''; // Rellenamos el campo imagen
            document.getElementById('modalTitle').innerText = "Editar MemÃ©tica";
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function renderApp() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = ''; let total = 0;
            sortableInstances.forEach(s => s.destroy()); sortableInstances = [];

            Object.keys(appData.groupMeta).forEach(gid => {
                const meta = appData.groupMeta[gid];
                const items = appData.groups[gid] || [];
                total += items.length;

                const section = document.createElement('div');
                section.className = "group-parent mb-12";
                
                const processDesc = (text) => {
                    if(!text) return '';
                    const parts = text.split('[');
                    let descHtml = `<p class="text-gray-400 text-sm leading-snug">${parts[0]}</p>`;
                    if (parts[1]) {
                        const tags = parts[1].replace('Tags:', '').replace(']', '').split(',');
                        descHtml += `<div class="flex flex-wrap gap-2 mt-3">
                            ${tags.map(t => `<span class="bg-orange-500/10 text-orange-400 border border-orange-500/30 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">${t.trim()}</span>`).join('')}
                        </div>`;
                    }
                    return descHtml;
                };

                section.innerHTML = `<div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-2"><h3 class="text-xl font-black uppercase italic ${meta.color}">${meta.title}</h3></div>`;
                const list = document.createElement('div');
                list.className = 'grid gap-4 min-h-[50px]';
                list.dataset.gid = gid;

                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'card-main rounded border border-gray-800 flex flex-col md:flex-row relative transition-all duration-300 hover:border-gray-500';
                    card.onclick = () => editItem(gid, item.id);
                    
                    // LÃ³gica para mostrar Imagen o Letra inicial
                    const iconContent = item.image 
                        ? `<img src="${item.image}" class="w-full h-full object-cover">`
                        : `<span class="text-2xl font-black text-black uppercase">${item.name.charAt(0)}</span>`;

                    card.innerHTML = `
                        <div class="w-24 md:w-32 flex items-center justify-center p-4 bg-black/30 border-r border-white/5 shrink-0">
                            <div class="w-20 h-20 rounded-full border-4 border-black overflow-hidden bg-amber-500 flex items-center justify-center">
                                ${iconContent}
                            </div>
                        </div>
                        <div class="flex-1 p-5 relative">
                            <h2 class="text-xl font-black tracking-tight uppercase italic text-white">${item.name}</h2>
                            <div class="border-l-2 border-amber-500/50 pl-3 my-2">${processDesc(item.desc)}</div>
                            <div class="flex gap-2 mt-2">${item.levels ? item.levels.split(',').map(l => `<span class="level-pill px-2 py-0.5 rounded text-xs font-bold text-gray-500 border border-white/5">${l.trim()}</span>`).join('') : ''}</div>
                            <div class="admin-only absolute top-4 right-4 text-orange-500 text-[10px] font-bold uppercase tracking-widest opacity-50">Editor Mode</div>
                        </div>
                    `;
                    list.appendChild(card);
                });
                section.appendChild(list); container.appendChild(section);

                if (isAdmin) {
                    sortableInstances.push(new Sortable(list, {
                        group: 'shared', animation: 150,
                        onEnd: async (evt) => {
                            const item = appData.groups[evt.from.dataset.gid].splice(evt.oldIndex, 1)[0];
                            appData.groups[evt.to.dataset.gid].splice(evt.newIndex, 0, item);
                            await fetch('/.netlify/functions/save_memetic', {
                                method: 'POST',
                                body: JSON.stringify({...item, group_id: evt.to.dataset.gid, description: item.desc, image_url: item.image})
                            });
                        }
                    }));
                }
            });
            document.getElementById('totalCount').innerText = total;
        }

        function filterItems() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.group-parent').forEach(group => {
                const cards = group.querySelectorAll('.card-main');
                let anyVisible = false;
                cards.forEach(card => {
                    const match = card.innerText.toLowerCase().includes(query);
                    card.style.display = match ? 'flex' : 'none';
                    if (match) anyVisible = true;
                });
                group.style.display = anyVisible ? 'block' : 'none';
            });
        }

        async function checkLogin() {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            const res = await fetch('/.netlify/functions/auth', { method: 'POST', body: JSON.stringify({ user, pass }) });
            if (res.ok) { setAdminUI(true); sessionStorage.setItem('is_admin', 'true'); closeModals(); renderApp(); }
            else alert("Acceso denegado");
        }

        function setAdminUI(enabled) {
            isAdmin = enabled;
            document.body.classList.toggle('is-admin', enabled);
            document.getElementById('authBtn').innerHTML = enabled ? 'ðŸ”“ Logout' : 'ðŸ”’ Admin Login';
            document.getElementById('modeDisplay').innerText = enabled ? "EDITOR" : "LECTURA";
        }

        function toggleAuth() {
            if (isAdmin) { setAdminUI(false); sessionStorage.removeItem('is_admin'); renderApp(); }
            else document.getElementById('loginModal').classList.remove('hidden');
        }

        function openItemModal() {
            document.getElementById('itemId').value = '';
            document.getElementById('itemForm').reset();
            document.getElementById('modalTitle').innerText = "Nueva MemÃ©tica";
            const select = document.getElementById('itemCategory');
            select.innerHTML = Object.entries(appData.groupMeta).map(([k,v]) => `<option value="${k}">${v.title}</option>`).join('');
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); }
        loadData();
    </script>
</body>
</html>